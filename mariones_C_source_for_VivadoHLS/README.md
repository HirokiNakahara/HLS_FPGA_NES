## これは何  
mariones スーパーマリオ専用エミュレータのCソースコード一式を
VivadoHLS向けに多少修正したもの.
Vivado HLS 2015.1で合成してNexys4で動作することを確認済み。
ただし、カートリッジはスーパーマリオブラザーズのみ。。

Developed by Hiroki Nakahara
 31, July, 2015

## ライセンス  
~~このコード一式はみきゃんウェアです。ゆるキャラグランプリ２０１５で
みきゃんに投票して頂ければ自由に配布・改変・公開してかまいません。~~
MITライセンスへ

## 修正内容  
VivadoHLS向けに, 元のCソースを多少修正しています  
・標準ライブラリをつかなわい記述に. 具体的にはfprintfをprintf,  
 memsetをfor文に書き換えています.  
・任意精度型に書き直し. #include "ap_cint.h"をインクルードし,  
 フラグにはuint1, BMP画像バッファはuint12に修正. それに伴い, PPUの  
 カラーパレットも修正しています. トップモジュールmariones_topに入力されている  
 ソフトリセットも当然uint1に.  
・主要（処理の重そうな）ループにラベルを付けました. Vivado HLSのAnalysisで  
　解析するときにとても役立ちます. 

## 内容物  
main.c          … テストベンチを含んだメイン関数。  
mariones_top.c  … NESのトップ関数。これ以下をVivado HLSで高位合成にかける。  
mbc.c           … メモリ部分をエミュレーション. 別配布のpartition_ROM.exe で分割した  
　　　　　　　      カートリッジイメージをここにコピペしてください。  
ppu.c           … PPU(描画ユニット)エミュレーション部  
registers.c     … レジスタエミュレーション部  
reset_nes.c     … NESのソフトウェアリセットを行う。起動時に呼び出し必須。  
RICHO2A03.c     … NESのCPUをエミュレーションする部分  
mariones.h      … ヘッダファイル。CPUの命令セットマクロとレジスタ・メモリの宣言  
partition_ROM.c … カートリッジイメージを分割するツール。Vivado HLSでは  
　　　　　　　　　　読み込まないように！！  
log.txt         … 試しにスーパーマリオを数十フレーム動作したときのCPUのログ出力。  
　　　　　　　　　  デバッグに使ってください。  
mov_mario.txt   … 別のエミュレータを使って記録したマリオのジョイパッド入力データ。  
　　　　　　　　　　Vivado HLSでCシミュレーションに使用。とりあえず、スタートを押すので  
　　　　　　　　　　別のカートリッジのデバッグにも使えるかもしれない。。  
screen_???.bmp  … 試しにスーパーマリオを数十フレーム動作したときのBMP画像の出力。  
　　　　　　　　　　Vivado HLSでCシミュレーションした結果と突き合わせるのに使う。  

## 環境  
【注意】修正したためVivadoHLSのCシミュレーション専用になっています...  

まず、NESのカートリッジイメージを用意します。私はArduinoを使って吸い出しました。  

ネットからダウンロードしたら違法だよ！カードリッジ買おうね！！  
ネットからダウンロードしたら違法だよ！カードリッジ買おうね！！（大事なことなので２回言った）  

現時点ではマッパー０、ミラーリング１のみ対応しています。つまり、スーパーマリオブラザーズ専用。  
他のカートリッジはまだ試していません。誰か人柱プリーズ。

## 実行方法  
別配布の partition_ROM.c をコンパイルしてバイナリを作ってください。  

$ gcc -O3 -o partition_ROM partition_ROM.c  

で、カートリッジイメージ（ここではsuper_mario.nes）を分割して埋め込み用のテンプレを生成します。  

$ ./partition_ROM supar_mario.nes  

実行すると  

[ROM INFO]  
ROM_SIZE: 32 KB, VROM_SIZE: 8 KB  
PROGRAM #PAGE: 2, CHARACTER #PAGE: 1  
MAPPER #0  
MIRRORING: 1  
IS_SRAM: 0  
IS_TRAINER: 0  
IS_FOUR_SCREEN: 0  

別のカートリッジでも同じ情報が出ると、そのまま使えるかも。  
同時に、ファイル(super_mario.nes_template.txt)を出力します。  
エディタでmbc.cを開いて、冒頭の配列にコピペしてください。  

Vivado HLSを起動してプロジェクトを作成します.  
 mariones_top.c, mariones.h, mbc.c, ppu.c, registers.c, reset_nes.c,  
 RICOH2A03.c   
 をソースコードとして読み込んでください.  
 main.c, mov_mario.txt   
 をテストベンチとして読み込んでください。  

この時点でCシミュレーション可能です.  
４００フレームエミュレーションを行います。フレーム数を変えたかったら main.c をいじってください。  
RICOH2A03.c のコメントアウトを外すとCPUのレジスタとかデバッグできます。  

【ポイント】 Cシミュレーション時に Optimizing Compile にチェックを入れておくと幸せになれます。  

しばらく時間がかかりますが、３分ほどで終了すると思います。　４０フレーム後には  
１０フレームごとにBMP画像を出力するようにしています。  

その後, Vivado HLSでC Synthesisを実行してください。なお、タイミングは20nsecに  
しています。そこそこ早く終わるはずです。FPGAエクストリームコンピューティングで詳細を説明しますが、  
リセット(config_rtlで指定)の設定もしておくと後々便利です。  
まぁ、しなくてもコンフィギュレーションすれば初期値を入れてくれるので動きますが。  

## 問い合わせ先  
Hiroki Nakahara, ~~@oboe7man (twitter)~~
忙しいので対応できないかもしれません、すみません…
